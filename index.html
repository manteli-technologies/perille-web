<html>
<head>

<script src="http://api.maps.ovi.com/jsl.js" type="text/javascript"></script>

<script type='text/javascript' src='./lib/jquery.js' ></script>
<script type='text/javascript' src='./lib/jquery-ui.js' ></script>
<link type='text/css' rel='stylesheet' href='./lib/jquery-theme/smoothness/jquery-ui-1.8.7.custom.css' /> 

<script type='text/javascript' src='./js/reittiopas.js' ></script>
<link type='text/css' rel='stylesheet' href='./style.css' />

</head>
<body>

<div id='entrypane' class='wrapper'>

<div id='results'>

</div>

<div class='entry'>
<input id='from' class='address-entry' />

<span class='button geolocation'>My location</span>

</div>

<div class='entry'>
<input id='to' class='address-entry' />

<span class='button geolocation'>My location</span>

</div>

<div class='entry'>

<input id='date' />

<input id='time' />

<span id='search' class='button'>Search</span>

</div>

<script type='text/javascript'>

// buttonize all buttons
$('.button').button();

var now = new Date();

$('#date').datepicker( {
	dateFormat : 'dd.mm.yy'
} );
$('#date').val( now.getDate() + '.' + (now.getMonth() + 1) + '.' + now.getFullYear() );

$('.address-entry').keyup( function() {
	var t = $(this);
	var address = t.val();
	// only search when there are 3 or more characters
	if( address.length < 3 ) { return; }
	reittiopas.address_to_location( address , function(data) {
		// hack
		var temp = data.map( function(data) {
			return { label: data.name, coords: data.coords };
		} );
		t.autocomplete( 'option', 'source', temp );
	} );
} );

$('.address-entry').autocomplete( { 
	minLenght : 3,
	select: function(event, ui) {
		$(this).data('location', ui.item.coords );
	}
} );

// geolocation when pressed
$('.geolocation').click( function() {
	var button = $(this);
	if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(
			function(position){
				reittiopas.location_to_address( position.coords.latitude, position.coords.longitude, function(json) {
					var field = button.parent().find('.address-entry');
					field.val( json[0].name );
					field.data('location', json[0].coords );
				}); },
			function(){
				alert('Nok!');
			}
		);
	} else {
	}
} );

$('#search').click( function() {
	$('#entrypane').hide('drop');
	reittiopas.route( $('#from').data('location'), $('#to').data('location'), new Date(), 'arrival', function(response) {
		console.log(response);
		$('#resultpane').show('drop');
		$.each( response, function( i, route ) {
			var item = $('<li>');
			var min = new Date( route[0].legs[0].locs[0].arrTime );
			item.html( min + ' ' + route[0].duration );
			var parts = $('<ol>');
			$.each( route[0].legs , function(i, leg) {
				parts.append( '<li>' + leg.code + '</li>' );
			} );
			item.append( parts );
			$('#routes').append( item );
		} );
	} );
} ); 

</script>

</div>

<div id='resultpane' style='display:none' class='wrapper'>

<ul id='routes'>

</ul>


<!-- <div id='map' style='width:400px;height:400px; float: rigth;'></div> -->
<script type='text/javascript'>
var map = new ovi.mapsapi.map.Display(document.getElementById("map"), {
  components: [ new ovi.mapsapi.map.component.Behavior(),
                new ovi.mapsapi.map.component.ZoomBar(),
                new ovi.mapsapi.map.component.Overview(),                                  
                new ovi.mapsapi.map.component.ScaleBar() ],
  zoomLevel: 10,
  center: [52.51, 13.4]
});
</script>
</div>

</body>
</html>
