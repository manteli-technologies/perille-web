<html>
<head>

<script src="http://api.maps.ovi.com/jsl.js" type="text/javascript"></script>

<script type='text/javascript' src='./lib/jquery.js' ></script>
<script type='text/javascript' src='./lib/jquery-ui.js' ></script>
<script type='text/javascript' src='./lib/jquery-ui-timepicker.js' ></script>
<link type='text/css' rel='stylesheet' href='./lib/jquery-theme/smoothness/jquery-ui-1.8.7.custom.css' /> 
<link type='text/css' rel='stylesheet' href='./lib/jquery-theme/jquery-timepicker.css' />


<script type='text/javascript' src='./js/reittiopas.js' ></script>
<script type='text/javascript' src='./js/reittiopas-hsl.js' ></script>
<link type='text/css' rel='stylesheet' href='./style.css' />

</head>
<body>

<span class='logo'>Perille</span> &ndash; uuden ajan reittiopas

<div id='entrypane' class='wrapper'>

<div id='results'>

</div>

<div class='entry'>
<input id='from' class='address-entry' />

<span class='button geolocation'>My location</span>

</div>

<div class='entry'>
<input id='to' class='address-entry' />

<span class='button geolocation'>My location</span>

</div>

<div class='entry'>

<input id='date' />

<input id='time' />

<span id='search' class='button'>Search</span>

</div>

<script type='text/javascript'>

// buttonize all buttons
$('.button').button();

function _addLeadingZero(digit){
	return digit < 10 ? '0' + digit : digit;
}

var now = new Date();

$('#date').datepicker( {
	dateFormat : 'dd.mm.yy'
} );
$('#date').val( _addLeadingZero(now.getDate()) + '.' + _addLeadingZero(now.getMonth() + 1) + '.' + now.getFullYear() );

$('#time').timepicker();
$('#time').val( _addLeadingZero(now.getHours()) + ':' + _addLeadingZero(now.getMinutes()) );

$('.address-entry').keyup( function() {
	var t = $(this);
	var address = t.val();
	// only search when there are 3 or more characters
	if( address.length < 3 ) { return; }
	reittiopas.address_to_location( address , function(data) {
		// hack
		var temp = data.map( function(data) {
			return { label: data.name, coords: data.coords };
		} );
		t.autocomplete( 'option', 'source', temp );
	} );
} );

$('.address-entry').autocomplete( { 
	minLenght : 3,
	select: function(event, ui) {
		$(this).data('location', ui.item.coords );
	}
} );

// geolocation when pressed
$('.geolocation').click( function() {
	var button = $(this);
	if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(
			function(position){
				reittiopas.location_to_address( position.coords.latitude, position.coords.longitude, function(json) {
					var field = button.parent().find('.address-entry');
					field.val( json[0].name );
					field.data('location', json[0].coords );
				}); },
			function(){
				alert('Nok!');
			}
		);
	} else {
	}
} );

// customize the Date toString-function
Date.prototype.toString = function(){
   // hh:mm
   return _addLeadingZero(this.getHours()) + ':' + _addLeadingZero(this.getMinutes());
}

$('#search').click( function() {
	$('#entrypane').hide('drop');
	$('#wait-icon').show();
	$('#wait-icon').effect('pulsate');
	reittiopas.route( $('#from').data('location'), $('#to').data('location'), new Date(), 'arrival', function(response) {
		$('#wait-icon').hide('explode');
		$('#resultpane').show('drop', 'slow');
		$.each( response, function( i, route ) {
			var item = $('<li>');
			var end = hsl.decode( route[0].legs[ route[0].legs.length - 1 ] )
			var start = hsl.decode( route[0].legs[0] );
			item.html( start.firstTime + '-' + end.lastTime );
			var parts = $('<ol>');
			$.each( route[0].legs , function(i, leg) {
				leg = hsl.decode( leg );
				parts.append( '<li>' + leg.type + ' ' + leg.firstTime + '-' + leg.lastTime + '</li>' );
			} );
			item.append( parts );
			$('#routes').append( item );
		} );
	} );
} );

</script>

</div>

<div id='wait-icon' style='background: blue; position: absolute; top: 25%; left: 25%; width: 50px; height: 50px; display: none;'></div>

<div id='resultpane' style='display:none' class='wrapper'>


<ul id='routes'>

</ul>


<!-- <div id='map' style='width:400px;height:400px; float: rigth;'></div> -->
<script type='text/javascript'>
var map = new ovi.mapsapi.map.Display(document.getElementById("map"), {
  components: [ new ovi.mapsapi.map.component.Behavior(),
                new ovi.mapsapi.map.component.ZoomBar(),
                new ovi.mapsapi.map.component.Overview(),                                  
                new ovi.mapsapi.map.component.ScaleBar() ],
  zoomLevel: 10,
  center: [52.51, 13.4]
});
</script>
</div>

</body>
</html>
